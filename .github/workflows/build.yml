name: Build FriendlyWrt with AmneziaWG (no luci-proto)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt version'
        required: true
        default: '24.10'
        type: choice
        options:
        - '23.05'
        - '24.10'
      kernel_branch:
        description: 'Kernel branch from friendlyarm/kernel-rockchip repo (e.g. nanopi6-v6.1.y for 6.1 kernel; leave empty for upstream from OpenWrt 6.6 kernel)'
        required: false
        default: ''
        type: string
      cpu:
        description: 'CPU / Model'
        required: true
        default: 'rk3576'
        type: choice
        options:
        - rk3328
        - rk3528
        - rk3399
        - rk3566
        - rk3568
        - rk3576
        - rk3588
      set:
        description: 'Variant'
        required: true
        default: 'non-docker'
        type: choice
        options:
        - non-docker
        - docker
      
jobs:
  prepare_release:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
    - name: Get release tag
      id: release_tag
      run: |
        release_tag="FriendlyWrt-$(date +%Y-%m-%d)"
        echo "release_tag=$release_tag" >> $GITHUB_OUTPUT

    - name: Create empty release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.release_tag.outputs.release_tag }}
        draft: false
        prerelease: false
    outputs:
      release_tag: ${{ steps.release_tag.outputs.release_tag }}

  build_friendlywrt:
    needs: prepare_release
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    strategy:
      matrix:
        include:
          - VERSION: ${{ inputs.version }}
            SET: ${{ inputs.set }}

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d
        wget https://raw.githubusercontent.com/friendlyarm/build-env-on-ubuntu-bionic/master/install.sh
        sed -i -e 's/^apt-get -y install openjdk-8-jdk/# apt-get -y install openjdk-8-jdk/g' install.sh
        sed -i -e 's/^\[ -d fa-toolchain \]/# [ -d fa-toolchain ]/g' install.sh
        sed -i -e 's/^(cat fa-toolchain/# (cat fa-toolchain/g' install.sh
        sed -i -e 's/^(tar xf fa-toolchain/# (tar xf fa-toolchain/g' install.sh
        sudo -E bash ./install.sh
        sudo -E git config --global user.name 'GitHub Actions'
        sudo -E git config --global user.email 'noreply@github.com'
        git clone https://github.com/friendlyarm/repo
        sudo -E cp repo/repo /usr/bin/
        mkdir -p ./artifact
        sudo swapoff -a
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk /usr/local/share/boost /opt/ghc

    - name: Download source
      run: |
        mkdir project
        cd project
        repo init --depth=1 -u https://github.com/friendlyarm/friendlywrt_manifests -b master-v${{ matrix.VERSION }} \
                -m ${{ inputs.cpu }}.xml --repo-url=https://github.com/friendlyarm/repo --no-clone-bundle

        repo sync -c friendlywrt --no-clone-bundle
        repo sync -c configs --no-clone-bundle
        repo sync -c device/common --no-clone-bundle
        repo sync -c device/friendlyelec --no-clone-bundle
        repo sync -c scripts --no-clone-bundle
        repo sync -c scripts/sd-fuse --no-clone-bundle
        repo sync -c toolchain --no-clone-bundle

    - name: Override kernel with BSP branch (if specified)
      if: inputs.kernel_branch != ''
      run: |
        cd project
        echo "Overriding kernel with branch: ${{ inputs.kernel_branch }}"
        rm -rf kernel
        git clone https://github.com/friendlyarm/kernel-rockchip.git kernel --depth 1 -b ${{ inputs.kernel_branch }}

    - name: Clean kernel cache after BSP override
      if: inputs.kernel_branch != ''
      run: |
        cd project/friendlywrt
        rm -rf build_dir/target-aarch64_generic_musl/linux*
        rm -rf staging_dir/target-aarch64_generic_musl/pkginfo/linux
        rm -rf bin/targets/rockchip/armv8/packages/kmod-*
        rm -rf tmp
        echo "Kernel cache cleaned manually"

    - name: Apply customizations
      run: |
        cd project
        source ../scripts/add_packages.sh
        source ../scripts/custome_config.sh

    - name: Prepare dot config and feeds
      run: |
        cd project
        [ "${{ matrix.SET }}" == "docker" ] && SUFFIX="-docker"
        DIRNAME=friendlywrt$(echo ${{ matrix.VERSION }}|awk -F . '{print $1}')${SUFFIX}
        CONFIG=rockchip${SUFFIX}
        cat > .current_config.mk <<EOL
        . device/friendlyelec/${{ inputs.cpu }}/base.mk
        TARGET_IMAGE_DIRNAME=${DIRNAME}
        TARGET_FRIENDLYWRT_CONFIG=${CONFIG}
        EOL
        DEBUG_DOT_CONFIG=1 ./build.sh friendlywrt

    - name: Compile BSP kernel (after config is ready)
      if: inputs.kernel_branch != ''
      run: |
        cd project
        ./build.sh kernel
        echo "BSP kernel compiled and installed"

    - name: Debug kernel version
      run: |
        cd project
        echo "Current kernel branch/tag:"
        cd kernel && git branch && git log -1 && cd ..
        echo "Compiled kernel Image exists?"
        ls -l out/Image || echo "No out/Image"
        echo "Kernel version from config (if available):"
        grep CONFIG_LOCALVERSION friendlywrt/.config || echo "Not found"
        echo "Kernel release (if built):"
        cat out/kernel-release 2>/dev/null || echo "Not found"

    - name: Download package
      run: |
        cd project/friendlywrt
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile friendlyWrt
      run: |
        cd project/friendlywrt
        make -j$(nproc) || make -j1 V=s

    - name: Create rootfs package
      id: create_rootfs_package
      run: |
        cd project
        source .current_config.mk
        [ "${{ matrix.SET }}" == "docker" ] && SUFFIX="-docker"
        rootfs_filename="rootfs-friendlywrt-${{ matrix.VERSION }}${SUFFIX}.tgz"
        tar cvzf ../artifact/${rootfs_filename} ${FRIENDLYWRT_SRC}/${FRIENDLYWRT_ROOTFS} \
              ${FRIENDLYWRT_SRC}/${FRIENDLYWRT_PACKAGE_DIR}
        echo "rootfs_filename=$rootfs_filename" >> $GITHUB_OUTPUT

    - name: Upload rootfs package
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./artifact/${{ steps.create_rootfs_package.outputs.rootfs_filename }}
        asset_name: ${{ steps.create_rootfs_package.outputs.rootfs_filename }}
        tag: ${{ needs.prepare_release.outputs.release_tag }}
        overwrite: true
